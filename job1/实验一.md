> 实验一

**实验目的**

- [ ] 如何配置无人值守安装iso并在Virtualbox中完成自动化安装
- [ ] Virtualbox安装完Ubuntu之后新添加的网卡如何实现系统开机自动启用和自动获取IP？
- [ ] 如何使用sftp在虚拟机和宿主机之间传输文件？

**实验环境**

- 主机：    win10

- 虚拟机： linux ubuntu18.04.1-server

  网络环境

  - NAT
  - host-only (169.254.150.150) 用于虚拟机和主机之间的通信

**实验过程**

- 首先在virtualbox中安装ubuntu18.04-server,然后为该虚拟机添加第二块host-only网卡，手动设置该网卡的ip为 169.254.150.150

  ```bash
   #打开配置文件
    vim /etc/netplan/01-netcfg.yaml
   
   #追加以下内容并保存
   network:
          ethernets:
                  enp0s8:
                          addresses: [169.254.150.150/24]
                          dhcp4: no
                          optional: true
          version: 2
          
   #应用改变
   sudo netplan apply
  ```

  ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/0.PNG)

- 配置宿主机putty ssh`免密登录`虚拟机

  - 首先在虚拟机中安装ssh `sudo apt install ssh` 使用用户名密码到登录虚拟机

  - 在宿主机中使用puttygen生成一对公私钥，下载私钥，并将公钥保存到虚拟机中

    ```
    #打开文件
    vim ~/.ssh/authorized_keys
    
    #将下图中公钥粘贴到文件中 并保存退出(x!)
    
    ```

    ![1](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/1.PNG)

    

  - 在putty中添加私钥，然后即可免密登录

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/2.PNG)

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/3.PNG)

- 创建iso镜像

  - 首先下载镜像到虚拟机   `wget http://sec.cuc.edu.cn/ftp/iso/ubuntu-16.04.1-server-amd64.iso`

  - 在当前用户目录下创建一个用于挂载iso镜像文件的目录  `mkdir loopdir`

  - 挂载iso镜像到该目录 `mount -o loop ubuntu-16.04.1-server-amd64.iso loopdir` 

  - 在当前用户目录下新建一个工作目录用于克隆光盘   `mkdir  cd`

  - 同步光盘内容到目标工作目录    `rsync -av loopdir/ cd`

  - 卸载iso镜像     `umont loopdir`

  - 进入工作目录 ~/cd , 编辑ubuntu安装引导界面增加一个新菜单项入口 

    ```bash
    #进入工作目录
    cd ~/cd
    
    #打开文件
    vim isolinux/txt.cfg  
    
    #添加以下内容到该文件后保存退出(放在文件最开始处)
    label autoinstall
      menu label ^Auto Install Ubuntu Server
      kernel /install/vmlinuz
      append  file=/cdrom/preseed/ubuntu-server-autoinstall.seed debian-installer/locale=en_US console-setup/layoutcode=us keyboard-configuration/layoutcode=us console-setup/ask_detect=false localechooser/translation/warn-light=true localechooser/translation/warn-severe=true initrd=/install/initrd.gz root=/dev/ram rw quiet
      
    ```

    对应的操作图片如下:

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/4.PNG)

  - 将配置完成的 `ubuntu-server-autoinstall.seed` 移到` ~/cd/preseed` 目录中

  - 修改isolinux/isolinux.cfg，增加内容`timeout 10`   

  - 重新生成md5sum.txt   `cd ~/cd **&&** find . -type f -print0 **|** xargs -0 md5sum > md5sum.txt`

  - 建立shell脚本并运行生成无人值守镜像

    ```bash
    #打开shell脚本
    vim shell
    
    #添加以下内容并保存退出
    IMAGE=custom.iso
    BUILD=~/cd/
    
    mkisofs -r -V "Custom Ubuntu Install CD" \
                -cache-inodes \
                -J -l -b isolinux/isolinux.bin \
                -c isolinux/boot.cat -no-emul-boot \
                -boot-load-size 4 -boot-info-table \
                -o $IMAGE $BUILD
                
    #如果当前用户为root用户 则build后跟的路径可以写为绝对路径
    
    #执行shell脚本 进行镜像刻录
    bash shell
    ```

    运行完毕生成截图如下:

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/5.PNG)

  - 将生成的无人值守镜像下载到本地

    ```bash
    #使用psftp.exe下载
    
      #登录
      psftp -l xhl -pw 123  xhl@169.254.150.150
      #下载 
      get /home/xhl/cd/custom.iso
      
      
    #使用pscp.exe下载
    pscp -l xhl -pw 123 xhl@169.254.150.150:/home/xhl/cd/custom.iso F:\test
    ```

  - 运行生成的无人值守镜像

    [录屏链接](https://www.bilibili.com/video/av45805186/)

- host-only 网卡实现开机自启动和自动获取ip

  ```bash
  #打开配置文件
  vim /etc/netplan/01-netcfg.yaml
  
  #修改配置文件  加入以下内容并保存
  auto enp0s8
  iface enp0s8 inet dhcp
  
  #应用改变
   sudo netplan apply
  ```

  

**思考**

- 用[在线文本对比工具](http://mergely.com/editor)对比，对比两个文件的不同

  - 选择支持地点 、跳过语言支持询问

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/7.PNG)

  - 修改链接超时、修改dhcp超时时间、启用手工配置网络

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/8.PNG)

  - 配置静态ip、网络掩码、网关ip、域名服务器ip

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/9.PNG)

  - 设置默认主机名、域名。 设置强制主机名

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/10.PNG)

  - 设置用户名 cuc，密码是sec.cuc.edu.cn

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/11.PNG)

  - 设置时区为上海、关闭时钟校正

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/12.PNG)

  - 选取最大空闲空间分区

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/13.PNG)

  - LVM方法使用尽可能多的卷组、使用group的预定义分区分配方法

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/14.PNG)

  - 不使用网络镜像

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/15.PNG)

  - 选用server的安装包、安装openssh-server、debootstrap后不更新、自动进行安全更新

    ![0](https://github.com/CUCCS/linux-2019-jackcily/raw/job1/img/16.PNG)

    

**问题**

- 运行bash脚本时系统提示找不到`mkisofs `命令 

  安装mkisofs  `sudo apt install mkisofs`

- 第一次安装无人值守镜像时内存不足自动崩溃

  关掉多余的进程重新进行安装

  

**参考**

- [ubuntu18下vbox配置虚拟机双网卡](http://blog.seclee.com/2018/05/21/ubuntu18xia-vboxpei-zhi-xu-ni-ji-shuang-wang-qia/)
- [在Linux服务器上使用PuTTY配置“无密码SSH密钥身份验证”](https://www.howtoing.com/ssh-passwordless-login-with-putty)